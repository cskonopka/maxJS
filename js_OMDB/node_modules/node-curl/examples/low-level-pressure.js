var Curl = require('../lib/Curl')

var p = console.log;
var url = process.argv[2];

times = 0;
check = function() {
	setTimeout(function() {
		p(Curl.get_count());
		if (Curl.get_count())
			check();
	}, 1000);
}

check();

var once = function() {
	++times;
	var curl = new Curl();

	if (!url)
		url = '127.0.0.1/hello.txt';

	curl.setopt('URL', url);
	curl.setopt('CONNECTTIMEOUT', 2);

	// on 'data' must be returns chunk.length, or means interrupt the transfer
	curl.on('data', function(chunk) {
		return chunk.length;
	});

	curl.on('error', function(e) {
		curl.close();
		once();
	});


	curl.on('end', function() {
		code = curl.getinfo('RESPONSE_CODE');
		curl.close();
		once();
	});

	curl.perform();
}
for(var i=0; i<1000; ++i)
	setTimeout(once, i)
