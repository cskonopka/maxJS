Curl   = require '../index'
assert = require 'assert'
j = 0;
do next = ->
	console.info "curl instances: ", Curl.get_count()
	setTimeout next, 1000

for i in [1..100]
	do (i) ->
		curl = Curl.create()
		do once = ->
			err, res = curl! 'localhost/upload.php', {
				multipart: [
					{name: 'file[]', file: '/home/miao/test.js'}
				]
			}
			if res.body.length != 421
				console.log res.body.toString()
			assert.equal res.body.length, 421
			if ++j % 100 == 0
				console.info j
			if j < 500000
				once()
			# res.close()
